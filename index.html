<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Profile Demo</title>

<style>
    body {
        font-family: Arial, sans-serif;
        padding: 20px;
    }

    #profileContainer {
        width: 200px;
        height: 200px;
        border-radius: 10px;
        border: 2px dashed #999;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
        background: #f9f9f9;
    }

    #profileImg {
        width: 100%;
        height: 100%;
        object-fit: cover;
        position: absolute;
        top: 0;
        left: 0;
        display: none;
        z-index: 1;
    }

    #uploadBtn {
        padding: 10px 15px;
        background: #1976d2;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        z-index: 2;
        position: absolute;
    }

    #editIcon {
        position: absolute;
        bottom: 5px;
        right: 5px;
        width: 24px;
        opacity: 0.7;
        cursor: pointer;
        display: none;
        z-index: 3;
    }

    #hiddenUpload {
        display: none;
    }

    iframe {
        display: none;
    }
</style>
</head>
<body>

<h2>Profile Picture</h2>

<div id="profileContainer">
    <img id="profileImg" />
    <button id="uploadBtn">Upload Photo</button>
    <!-- 替换为 base64 编码的编辑图标 -->
    <img id="editIcon" src="" />
</div>

<input type="file" accept="image/*" id="hiddenUpload">

<iframe id="hiddenFrame" name="hiddenFrame"></iframe>

<form id="uploadForm" action="https://script.google.com/macros/s/AKfycbyKMVs0oC7upw9GzaEPYnLAR04zKMI9L8TnKaG14UQekMf8Zw1_2eMNQLUp4I_JjWQI/exec" method="POST" target="hiddenFrame" style="display:none;">
    <input type="hidden" name="action" value="saveBase64">
    <input type="hidden" name="base64" id="base64Field">
    <input type="hidden" name="user" id="userField" value="Cyril"> <!-- 添加这一行，只需修改这里的值 -->
</form>

<script>
const uploadBtn = document.getElementById("uploadBtn");
const hiddenUpload = document.getElementById("hiddenUpload");
const profileImg = document.getElementById("profileImg");
const editIcon = document.getElementById("editIcon");
const base64Field = document.getElementById("base64Field");
const userField = document.getElementById("userField");

// 获取用户名（从表单字段读取）
const CURRENT_USER = userField.value; // 这里自动获取表单中的用户名

const GAS_URL = "https://script.google.com/macros/s/AKfycbyBLabIKIt7U9L_pDRmYLNFC5opuEH_zvvCXTD6VGPuLt5myPSgmcizBuW-emrktgRk/exec";

// 点击按钮 → 打开文件选择
uploadBtn.onclick = () => hiddenUpload.click();

// 用户选择照片
hiddenUpload.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const compressed = await compressImage(file, 700);
    const base64 = compressed.split(",")[1];

    // 显示图片
    profileImg.src = compressed;
    profileImg.style.display = "block";
    editIcon.style.display = "block";

    // 上传按钮隐藏
    uploadBtn.style.display = "none";

    // form 提交
    base64Field.value = base64;
    userField.value = CURRENT_USER; // 确保用户信息正确
    document.getElementById("uploadForm").submit();
};

// 压缩函数（Canvas）
function compressImage(file, maxWidth) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (evt) => {
            const img = new Image();
            img.onload = () => {
                const scale = Math.min(maxWidth / img.width, 1); // 避免放大
                const canvas = document.createElement("canvas");
                canvas.width = img.width * scale;
                canvas.height = img.height * scale;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                resolve(canvas.toDataURL("image/jpeg", 0.75));
            };
            img.src = evt.target.result;
        };
        reader.readAsDataURL(file);
    });
}

// 页面加载 → 自动取 Base64 显示
async function loadImageFromGAS() {
    // 添加用户参数到URL
    const res = await fetch(GAS_URL + "?action=getBase64&user=" + encodeURIComponent(CURRENT_USER));
    const text = await res.text();

    if (text.trim() !== "") {
        profileImg.src = "data:image/jpeg;base64," + text;
        profileImg.style.display = "block";
        editIcon.style.display = "block";
        uploadBtn.style.display = "none"; // 图片存在 → 按钮隐藏
    }
}
loadImageFromGAS();

// 点击笔 → 删除图片
editIcon.onclick = async () => {
    if (!confirm("Remove this profile picture?")) return;

    profileImg.style.display = "none";
    editIcon.style.display = "none";

    // 上传按钮显示
    uploadBtn.style.display = "block";

    // 删除时添加用户参数
    await fetch(GAS_URL + "?action=deleteBase64&user=" + encodeURIComponent(CURRENT_USER));
};
</script>

</body>
</html>
